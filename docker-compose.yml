services:
  registry:
    image: registry:2
    container_name: registry
    ports:
      - "5000:5000"
    volumes:
      - /media/de/data/registry:/var/lib/registry
      - /media/de/data/registry/certs:/certs
      - /media/de/data/registry/config.yml:/etc/docker/registry/config.yml 
    restart: always
    environment:
      REGISTRY_HTTP_ADDR: :5000
      REGISTRY_HTTP_TLS_CERTIFICATE: /certs/domain.crt
      REGISTRY_HTTP_TLS_KEY: /certs/domain.key
    networks:
      - storage_network
    command: ["registry", "serve", "/etc/docker/registry/config.yml"]
    healthcheck:
      test: ["CMD-SHELL", "wget --no-check-certificate --no-verbose --tries=1 --spider https://localhost:5000/v2/_catalog || exit 1"]
      interval: 30s  
      timeout: 10s   
      retries: 3     
      start_period: 30s 

  # 웹 UI (React) + 인증서/스크립트/문서 서버
  cert-server:
    build:
      context: ./web/app
      dockerfile: Dockerfile
    image: registry-cert-server:latest
    container_name: registry-cert-server
    ports:
      - "9000:80"
    volumes:
      - /media/de/data/registry/certs:/usr/share/nginx/html/certs:ro
      - ./scripts:/usr/share/nginx/html/scripts:ro
      - ./docs:/usr/share/nginx/html/docs:ro
      - ./web/docker:/usr/share/nginx/html/docker:ro
      - ./config/nginx-cert-server.conf:/etc/nginx/conf.d/default.conf:ro
    networks:
      - storage_network
    restart: always
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/"]
      interval: 30s
      timeout: 10s
      retries: 3

networks:
  storage_network:
    driver: bridge
    external: true
