# Registry에서 Pull 후 실행 (설정값 이미지 포함)
# 사용: REGISTRY={REGISTRY IP}:{PORT} IMAGE_TAG=v1.0.0 docker compose -f docker-compose.registry.yml up -d

name: mqtt-telegraf-demo

services:
  mosquitto:
    image: ${REGISTRY:-{REGISTRY IP}:{PORT}}/mosquitto-demo:${IMAGE_TAG:-latest}
    container_name: mqtt-mosquitto
    ports:
      - "1883:1883"
      - "9001:9001"
    volumes:
      - mosquitto_data:/mosquitto/data
      - mosquitto_log:/mosquitto/log
    healthcheck:
      test: ["CMD", "mosquitto_sub", "-t", "$$SYS/#", "-C", "1", "-W", "3"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 5s
    restart: unless-stopped

  telegraf:
    image: ${REGISTRY:-{REGISTRY IP}:{PORT}}/telegraf-demo:${IMAGE_TAG:-latest}
    container_name: telegraf
    volumes:
      - telegraf_out:/var/lib/telegraf
    environment:
      - HOSTNAME=telegraf-docker
    depends_on:
      mosquitto:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "pgrep", "-x", "telegraf"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s
    restart: unless-stopped

  web:
    image: ${REGISTRY:-{REGISTRY IP}:{PORT}}/mqtt-telegraf-demo-web:${IMAGE_TAG:-latest}
    container_name: mqtt-web
    ports:
      - "8888:80"
    restart: unless-stopped

  api:
    image: ${REGISTRY:-{REGISTRY IP}:{PORT}}/mqtt-telegraf-demo-api:${IMAGE_TAG:-latest}
    container_name: mqtt-api
    ports:
      - "8889:5000"
    volumes:
      - telegraf_out:/data:ro
    depends_on:
      telegraf:
        condition: service_started
    restart: unless-stopped

volumes:
  mosquitto_data:
  mosquitto_log:
  telegraf_out:
